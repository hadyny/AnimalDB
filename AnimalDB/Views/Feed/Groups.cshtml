@model IEnumerable<AnimalDB.Repo.Entities.FeedingGroup>

<h3>@Html.ActionLink("Back to Rooms", "Index", null, new { @class = "btn btn-primary" })</h3>



@if (Model.Count() != 0)
{
    <h3>
        KEY: <span class="btn btn-success ">All animals fed today</span>&nbsp;<span class="btn btn-orange ">Some animals fed today</span>&nbsp;<span class="btn btn-danger ">No animals fed today</span>
    </h3>
}
<hr />

<h1>@ViewBag.RoomName</h1>

@if ((ViewBag.NumAppAnimals != 0 || (bool)ViewBag.AnimalsNotInDB) &&
    (User.IsInRole("Technician") ||
    User.IsInRole("Administrator") ||
    DateTime.Now.DayOfWeek == DayOfWeek.Saturday ||
    DateTime.Now.DayOfWeek == DayOfWeek.Sunday))
{



    if (!(bool)ViewBag.AnimalsNotInDB)
    {
        if (!(bool)ViewBag.AllChecked)
        {
            @Html.ActionLink("Mark all animals in the room as checked today", "MarkAllAnimalsChecked", new { roomId = ViewBag.RoomId }, new { @class = "btn  btn-success" })
        }
        else
        {
            <p class="lead">All animals have been checked today <span class="text-success fas fa-check-circle"></span></p>
        }
    }
    else
    {
        if (!(bool)ViewBag.LastRoomCheckToday)
        {
            @Html.ActionLink("Mark the room as checked today", "MarkRoomChecked", new { roomId = ViewBag.RoomId }, new { @class = "btn  btn-success" })
        }
        else
        {
            <p class="lead">Room has been checked today <span class="text-success fas fa-check-circle"></span></p>
        }
    }

}
<hr />
<div class="row">

    @if (Model.Count() != 0)
    {
        <div class="col-md-6">

            <h2>Select Feeding Group:</h2>

            <ul>
                @foreach (var item in Model.Where(m => m.Animals.Count() != 0).OrderBy(m => m.Description))
                {
                    string _class = "";
                    int fed = item.Animals.Where(m => m.Feeds.Count(n => n.Date == DateTime.Now.Date && n.FeedAmount != null) != 0 || (m.Feeds.Count() != 0 && m.Feeds.OrderBy(p => p.Date).Last().FeedAmount == -1)).Count();
                    //int notChecked = item.Animals.Count(m => m.DeathDate == null && m.LastChecked.Date != DateTime.Now.Date);
                    int total = item.Animals.Count(m => m.DeathDate == null);

                    if (fed == total)
                    {
                        _class = "btn-success";
                    }
                    else if (fed > 0 && fed < total)
                    {
                        _class = "btn-orange";
                    }
                    else
                    {
                        _class = "btn-danger";
                    }
                    <li>
                        @Html.ActionLink(Html.DisplayFor(modelItem => item.Description).ToString(), "Add", "Feed", new { id = item.Id }, new { @class = "btn  " + _class })
                    </li>
                }
            </ul>
        </div>
    }




    else
    {
        <div class="col-md-6">
            <h4>Animal checks from the past week:</h4>
            <hr />
            <table class="table table-striped">
                <thead><tr><th>Day</th><th>Checked</th></tr></thead>
                @if (!(bool)ViewBag.AnimalsNotInDB)
                {
                    for (DateTime date = DateTime.Now.Date; date > DateTime.Now.Date.AddDays(-7); date = date.AddDays(-1))
                    {
                        AnimalDB.Repo.Entities.Room room = ViewBag.Room;
                    <tr>
                        <td>
                            @date.ToShortDateString()
                        </td>
                        <td>
                            <div class="btn-group dropdown">
                                @if (date.Date == DateTime.Now.Date)
                                {
                                    if (room.Animals.Count(m => m.LastChecked.Date == DateTime.Today.Date && m.DeathDate == null) == room.Animals.Count(m => m.DeathDate == null))
                                    {
                                        <button title="All animals checked" type="button" class="btn btn-sm btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <span class="fas fa-check-circle"></span>
                                        </button>

                                    }
                                    else if (room.Animals.Count(m => m.LastChecked.Date == DateTime.Today.Date && m.DeathDate == null) == 0)
                                    {
                                        <button title="Animals not checked" type="button" class="btn btn-sm btn-danger dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <span class="fas fa-times-circle"></span>
                                        </button>
                                    }
                                    else
                                    {
                                        <button title="Some animals not checked" type="button" class="btn btn-sm btn-warning dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <span class="fas fa-exclamation-circle"></span>
                                        </button>
                                    }
                                }
                                else if (room.Animals.Count(m => m.DeathDate == null && m.MissedChecks.Count(n => n.Timestamp.Date == date.Date) != 0) == 0)
                                {
                                    <button title="All animals checked" type="button" class="btn btn-sm btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <span class="fas fa-check-circle"></span>
                                    </button>
                                }
                                else if (room.Animals.Count(m => m.DeathDate == null && m.MissedChecks.Count(n => n.Timestamp.Date == date.Date) != 0) == room.Animals.Count(m => m.DeathDate == null))
                                {
                                    <button title="Animals not checked" type="button" class="btn btn-sm btn-danger dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <span class="fas fa-times-circle"></span>
                                    </button>
                                }
                                else
                                {
                                    <button title="Some animals not checked" type="button" class="btn btn-sm btn-warning dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <span class="fas fa-exclamation-circle"></span>
                                    </button>
                                }
                                <ul class="dropdown-menu">
                                    @foreach (var animal in room.Animals.Where(m => m.DeathDate == null))
                                    {
                                        if (animal.MissedChecks.Count(m => m.Timestamp.Date == date.Date) != 0 || (date.Date == DateTime.Now.Date && animal.LastChecked.Date != DateTime.Now.Date))
                                        {
                                            <li class="dropdown-item"><a><span class="text-danger fas fa-times-circle"></span> @animal.UniqueAnimalId</a></li>
                                        }
                                        else
                                        {
                                            <li class="dropdown-item"><a><span class="text-success fas fa-check-circle"></span> @animal.UniqueAnimalId</a></li>
                                        }
                                    }
                                </ul>
                            </div>
                        </td>
                    </tr>
                    }
                }
                else
                {
                    for (DateTime date = DateTime.Now.Date; date > DateTime.Now.Date.AddDays(-7); date = date.AddDays(-1))
                    {
                        AnimalDB.Repo.Entities.Room room = ViewBag.Room;
                        <tr>
                            <td>
                                @date.ToShortDateString()
                            </td>
                            <td>
                                <div class="btn-group">
                                    @if (date.Date == DateTime.Now.Date)
                                    {
                                        if (room.NoDBAnimalsLastCheck.HasValue && room.NoDBAnimalsLastCheck.Value.Date == DateTime.Now.Date)
                                        {
                                            <button title="Room checked" type="button" class="btn btn-success" aria-haspopup="true" aria-expanded="false">
                                                <span class="fas fa-check-circle"></span>
                                            </button>

                                        }
                                        else 
                                        {
                                            <button title="Room not checked" type="button" class="btn btn-danger" aria-haspopup="true" aria-expanded="false">
                                                <span class="fas fa-times-circle"></span>
                                            </button>
                                        }
                                    }
                                    else if (room.MissedChecks.Count(m => m.Timestamp.Date == date.Date) == 0)
                                    {
                                        <button title="Room checked" type="button" class="btn btn-success" aria-haspopup="true" aria-expanded="false">
                                            <span class="fas fa-check-circle"></span>
                                        </button>
                                    }
                                    else 
                                    {
                                        <button title="Room not checked" type="button" class="btn btn-danger" aria-haspopup="true" aria-expanded="false">
                                            <span class="fas fa-times-circle"></span>
                                        </button>
                                    }
                                    
                                </div>

                            </td>
                        </tr>
                    }
                }
            </table>


        </div>
    }




    @if (ViewBag.NumAppAnimals != 0)
            {
        <div class="col-md-6">

            @if (ViewBag.DoneToday == "0" && (User.IsInRole("Technician") || User.IsInRole("Administrator")))
            {
                <h4>
                    There should be @ViewBag.NumAppAnimals @if (ViewBag.NumAppAnimals == 1)
                    { <text>animal</text> }
                    else
                    { <text>animals</text> } (including @ViewBag.GMOCount GMO) in this room.
                    @Html.ActionLink("View All", "Animals", "Rooms", new { id = ViewBag.RoomId, grps = "1" }, new { @class = "btn btn-sm btn-outline-dark" })
                    @if (ViewBag.GMOCount != 0)
                    {
                    @Html.ActionLink("View GMO", "Animals", "Rooms", new { id = ViewBag.RoomId, grps = "1", gmo = "1" }, new { @class = "btn btn-sm btn-outline-dark" })
                    }
                </h4>
                        <form method="post"><button type="submit" class="btn  btn-success">This is correct</button></form>
            }
            else if (User.IsInRole("Technician") || User.IsInRole("Administrator"))
            {
                <h4>
                    This week there @if (ViewBag.NumAppAnimals == 1)
                    { <text>is 1 animal</text> }
                    else
                    { <text>are @ViewBag.NumAppAnimals animals</text> } (including @ViewBag.GMOCount GMO) in this room.
                    @Html.ActionLink("View All", "Animals", "Rooms", new { id = ViewBag.RoomId, grps = "1" }, new { @class = "btn btn-sm btn-outline-dark" })
                    @if (ViewBag.GMOCount != 0)
                    {
                    @Html.ActionLink("View GMO", "Animals", "Rooms", new { id = ViewBag.RoomId, grps = "1", gmo = "1" }, new { @class = "btn btn-sm btn-outline-dark" })
                    }
                </h4>
            }
            <hr />
            <table class="table table-striped">
                <thead><tr><th>Week of</th><th>Count</th></tr></thead>

                @for (DateTime date = ViewBag.startDay; date > DateTime.Now.AddDays(-140); date = date.AddDays(-7))
                {
                    var history = (ViewBag.CountHistory as List<AnimalDB.Repo.Entities.AnimalRoomCount>).SingleOrDefault(m => m.Timestamp.Date == date.Date);
                    if (history != null)
                    {
                        <tr>
                            <td>
                                @history.Timestamp.Date.ToShortDateString() @if (date.Date == ViewBag.startDay.Date)
                                { <text>(This week)</text> }
                            </td>
                            <td>@history.Count (including @history.GMOCount GMO)</td>
                        </tr>
                    }
                    else
                    {
                        <tr class="danger">
                            <td>@date.ToShortDateString()</td>
                            <td></td>
                        </tr>
                    }
                }
            </table>
        </div>
    }
</div>
<hr />